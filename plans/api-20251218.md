# API Change Plans for llm-json-stream
> Written on 2025-12-18

This document outlines the planned API changes for the `llm-json-stream` package based on the changelog entries up to version 0.1.0.

## The Target API
### 1. Setup:
```typescript
interface User {
    name: string;
    age: number;
    email: string;
}

interface UsersResponse {
    label: string;
    description: string;
    users: User[];
}

// The LLM is told to write a JSON of users list
const response = await llm.sendPrompt(prompt);
```

### 2. Creating an instance:
```typescript
const usersAsync = parse<UsersResponse>(response);
```
- This allows for a schema to be enforced
- This empowers TypeScript users with autocomplete
- This lets Javascript users to not define types

### 3. Property Access:
```typescript
// Promises
const label = await usersAsync.label;

// Streaming chunks
for await (const chunk of usersAsync.description) {
    console.log(chunk);
}

// Streaming array items
for await (const user of usersAsync.users) {
    // [user] is an AsyncJson<User>
    for await (const nameChunk of user.name) {
        console.log(nameChunk);
    }
}

// Streaming final array items
for await (const user of usersAsync.users.final) {
    console.log(`User: ${await user.name}, Age: ${await user.age}`);
}

// Deep nested access
const firstUserEmail = await usersAsync.users[0].email;
```
- This largely simplifies the API
- This also removes a lot of boierplate

### 4. Type Safety
```typescript
// Inferred as string due to schema
const name = await usersAsync.users[0].name;

// Inferred as AsyncJson<number>
const ageAsync = usersAsync.users[0].age;
```
## Side-To-Side Preview of the API Change
Lets say this is for a blog response:
### Current API
```typescript
const parser = new JsonStreamParser(response);

const label = await parser.getStringProperty('label').promise;

for await (const chunk of parser.getStringProperty('description')) {
    console.log(chunk);
}
```
### New API
```typescript
const blog = JsonStream.parse<BlogResponse>(response);

const label = await blog.label;

for await (const chunk of blog.description) {
    console.log(chunk);
}
```

## Steps to Transition to the New API

A. **Create new schema-full tests**
- Create a new set of tests that use the new `JsonStream.parse<T>(stream)` API with schema interfaces
    - Cover all property types: string, number, boolean, null, list, map
    - Cover nested properties and arrays
    - Cover streaming chunks and final values
    - Cover error handling and edge cases

A. **Migrate to late-binding parsing**
- Update all the tests to use to use `JsonStream.parse<T>(stream)` instead of `new JsonStreamParser(stream)`, where T is an optional schema interface
    - So when Copilot rewrites the code, it can keep running the tests to make sure it still works
- Implement late-binding parsing to support the new `JsonStream.parse<T>(stream)` function
    - Basically, we only infer the stream type only when the property starts generating already

A. **Flatten PropertyStream**
- Update all tests to use the flattened API without `.promise` property
    - So when Copilot rewrites the code, it can keep running the tests to make sure it still works
- Refactor `PropertyStream` and its subclasses (`StringProperty`, `NumberProperty`, etc) *thenable* and iterable (already done), removing the need for `.promise` property

## Questions to answer
1. What is the new name for `JsonStreamParser`?
2. What is the new name for `PropertyStream` and its subclasses?

## Snapshots of old code for reference
### Current lists of tests and coverage
- **Property Type Tests** (in `properties/` folder)
    - `string_property.test.ts`
        - Tests for string property parsing with streaming interface
        - Covers: simple strings, escape sequences (newline, tab, quotes, backslash), empty strings, unicode/emoji characters, long strings chunked across multiple stream chunks, nested properties, async iterator patterns
        - Total: 11 test cases
    - `number_property.test.ts`
        - Tests for numeric property parsing (atomic values - emit once)
        - Covers: positive/negative integers, zero, negative zero, floating point, scientific notation, nested numbers, numbers in arrays, multiple number properties
        - Total: 15+ test cases
    - `boolean_property.test.ts`
        - Tests for boolean property parsing (atomic values - emit once)
        - Covers: true/false values, nested booleans, booleans in arrays, multiple boolean properties, async iterator patterns
        - Total: 9+ test cases
    - `null_property.test.ts`
        - Tests for null property parsing (atomic values - emit once)
        - Covers: null values, nested nulls, nulls in arrays, multiple null properties, async iterator emit behavior
        - Total: 9+ test cases
    - `list_property.test.ts`
        - Tests for array/list property parsing with snapshot emissions
        - Covers: simple arrays, empty arrays, arrays of strings/objects/mixed types, nested arrays, element access by index, onElement callbacks, streaming snapshots
        - Total: 15+ test cases
    - `map_property.test.ts`
        - Tests for object/map property parsing with snapshot emissions
        - Covers: simple objects, empty objects, nested objects, mixed value types, deeply nested objects, dot notation access, chainable property access, async iterator snapshots
        - Total: 12+ test cases

- **Integration & Robustness Tests** (in root `test/` folder)
    - `comprehensive_demo.test.ts`
        - Matrix testing of chunk sizes and stream speeds
        - Covers: variations with chunkSize [1, 3, 10, 50, 100, 1000] and speeds [0, 5, 50, 100]ms
    - `stream_completion.test.ts`
        - Tests for stream completion and promise resolution
        - Covers: all properties completing when stream ends, futures resolution, incomplete property handling
    - `error_handling.test.ts`
        - Tests for error handling and edge cases
        - Covers: complete JSON parsing, slow stream timeouts, empty objects, whitespace handling
    - `incremental_updates.test.ts`
        - Tests for incremental property updates during streaming
    - `buffer_flush.test.ts`
        - Tests for buffer flushing behavior
    - `disposal.test.ts`
        - Tests for proper resource cleanup and disposal
    - `multiline_json.test.ts`
        - Tests for multiline JSON parsing
    - `trailing_commas.test.ts`
        - Tests for trailing comma handling
    - `llm_robustness.test.ts`
        - Tests for LLM-generated JSON robustness
    - `comprehensive_value_retrieval.test.ts`
        - Tests for comprehensive value retrieval scenarios
    - `map_on_property.test.ts`
        - Tests for map operations on properties
    - `debug_simple.test.ts`, `debug_nested_list.test.ts`, `bug_diagnosis.test.ts`, `critical_bug.test.ts`, `yap_filter.test.ts`
        - Focused debugging and bug reproduction tests 